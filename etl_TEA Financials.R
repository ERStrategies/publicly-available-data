#Authour: Jenny Katz
#Date: 2/9/2023
#Description:  Scrapes data from TEA Education Agency ACtual Financials:
#https://rptsvr1.tea.texas.gov/school.finance/forecasting/financial_reports/1920_FinActRep.html

library(rvest)



#set variables
base_url<- "https://rptsvr1.tea.texas.gov/cgi/sas/broker?_service=marykay&_program=sfadhoc.actual_report_2020.sas&_service=appserv&_debug=0&who_box=&who_list="
save_location <-"/Education Resource Strategies/ERS Data - Documents/Public Data/Texas SGS"
user_name <- "C:/Users/jdavidow" #update to you username
cdns <- #stores the district IDS to build up the URL
  list("109901",
       "095901",
       "221901",
       "014901",
       "180903",
       "178901",
       "015901",
       "250906",
       "209901",
       "101902",
       "184907",
       "125901",
       "101903",
       "043901",
       "022901",
       "037901",
       "126901",
       "020901",
       "249901",
       "188901",
       "140901",
       "036901",
       "093901",
       "002901",
       "020902",
       "043902",
       "127901",
       "071906",
       "110901",
       "228905",
       "109912",
       "004901",
       "205901",
       "005901",
       "061910",
       "220901",
       "212901",
       "217901",
       "107901",
       "034901",
       "061907",
       "227901",
       "196901",
       "070901",
       "194902",
       "034902",
       "161918",
       "220915",
       "030903",
       "200901",
       "195902",
       "010902",
       "025901",
       "178913",
       "036902",
       "014902",
       "011901",
       "158901",
       "123910",
       "183901",
       "013901",
       "039904",
       "091901",
       "008901",
       "014903",
       "125902",
       "066901",
       "138904",
       "187901",
       "230901",
       "114901",
       "220902",
       "178902",
       "177903",
       "016902",
       "116915",
       "025904",
       "034909",
       "175902",
       "235901",
       "043917",
       "072904",
       "109913",
       "130901",
       "116916",
       "241901",
       "074903",
       "148901",
       "017901",
       "117901",
       "161923",
       "185901",
       "169901",
       "249902",
       "136901",
       "160901",
       "008903",
       "020905",
       "215901",
       "198901",
       "239901",
       "181901",
       "249903",
       "203902",
       "184909",
       "041901",
       "121902",
       "025908",
       "024901",
       "223901",
       "107902",
       "031901",
       "025902",
       "161919",
       "021902",
       "119901",
       "166907",
       "186901",
       "145901",
       "212902",
       "121903",
       "243901",
       "176901",
       "126902",
       "027903",
       "239903",
       "188904",
       "109902",
       "116901",
       "178903",
       "026901",
       "029901",
       "049905",
       "198902",
       "166901",
       "116910",
       "106901",
       "234902",
       "071907",
       "191901",
       "201913",
       "064903",
       "220919",
       "057903",
       "183902",
       "220917",
       "001902",
       "057904",
       "116902",
       "043903",
       "210901",
       "133901",
       "145902",
       "228904",
       "174908",
       "003907",
       "101905",
       "103901",
       "212909",
       "225906",
       "007901",
       "206903",
       "229906",
       "249904",
       "038901",
       "099902",
       "073901",
       "161920",
       "174901",
       "139905",
       "226901",
       "067902",
       "243906",
       "065901",
       "194904",
       "006902",
       "084910",
       "126903",
       "146901",
       "018901",
       "071901",
       "030902",
       "114902",
       "204901",
       "042901",
       "021901",
       "091902",
       "229901",
       "168901",
       "020907",
       "045902",
       "046902",
       "047901",
       "130902",
       "116903",
       "043918",
       "112908",
       "233903",
       "161921",
       "170902",
       "147901",
       "060902",
       "057922",
       "050910",
       "178904",
       "187904",
       "175903",
       "095902",
       "142901",
       "246914",
       "109903",
       "129901",
       "052901",
       "018908",
       "161901",
       "053001",
       "113901",
       "101906",
       "054901",
       "030901",
       "107904",
       "078901",
       "220912",
       "254901",
       "062901",
       "055901",
       "112905",
       "174902",
       "101907",
       "163902",
       "172902",
       "056901",
       "057905",
       "020910",
       "020904",
       "148905",
       "058902",
       "175904",
       "146902",
       "047902",
       "019901",
       "057906",
       "249905",
       "101908",
       "227910",
       "115903",
       "091903",
       "061901",
       "251901",
       "194905",
       "146903",
       "163901",
       "081906",
       "176903",
       "003905",
       "084901",
       "082902",
       "144903",
       "035901",
       "133905",
       "074904",
       "108902",
       "086024",
       "174911",
       "105904",
       "178905",
       "072902",
       "171901",
       "057907",
       "220918",
       "159901",
       "227909",
       "025909",
       "241902",
       "015911",
       "036903",
       "067903",
       "068901",
       "074905",
       "108903",
       "048901",
       "015905",
       "234903",
       "108904",
       "120901",
       "241903",
       "071902",
       "243902",
       "011902",
       "001903",
       "102906",
       "070903",
       "049906",
       "174910",
       "030906",
       "107905",
       "121906",
       "050901",
       "220904",
       "210906",
       "143906",
       "071903",
       "081902",
       "128904",
       "060914",
       "043904",
       "185902",
       "075906",
       "070905",
       "075901",
       "246902",
       "247901",
       "178914",
       "077901",
       "148902",
       "169910",
       "129902",
       "114904",
       "079907",
       "122901",
       "242906",
       "115901",
       "186902",
       "220905",
       "198903",
       "001904",
       "086901",
       "066903",
       "152907",
       "084911",
       "185903",
       "043905",
       "175905",
       "234909",
       "049901",
       "101910",
       "084902",
       "120902",
       "057909",
       "184911",
       "174903",
       "183904",
       "050902",
       "166902",
       "149901",
       "246904",
       "161925",
       "144901",
       "230902",
       "092901",
       "087901",
       "213901",
       "126911",
       "169906",
       "167901",
       "088902",
       "089901",
       "187903",
       "101911",
       "182901",
       "067904",
       "156905",
       "182902",
       "252901",
       "111901",
       "057910",
       "234904",
       "238904",
       "126904",
       "090905",
       "246905",
       "226907",
       "113902",
       "220906",
       "116905",
       "165902",
       "205902",
       "147902",
       "033901",
       "228901",
       "098901",
       "091917",
       "047903",
       "135001",
       "095903",
       "143901",
       "161924",
       "102904",
       "097902",
       "127903",
       "123914",
       "219901",
       "146904",
       "100905",
       "015904",
       "102905",
       "031903",
       "230905",
       "086902",
       "244901",
       "035902",
       "103902",
       "225907",
       "104901",
       "250902",
       "127904",
       "105906",
       "198905",
       "065902",
       "202903",
       "237902",
       "201902",
       "039902",
       "059901",
       "208901",
       "097903",
       "108905",
       "148903",
       "084903",
       "177905",
       "057911",
       "188903",
       "109904",
       "084908",
       "014905",
       "005902",
       "163904",
       "074907",
       "019902",
       "101912",
       "091905",
       "019913",
       "109905",
       "072908",
       "003902",
       "101925",
       "034903",
       "146905",
       "101913",
       "133902",
       "003904",
       "236902",
       "220916",
       "246906",
       "152910",
       "120905",
       "205903",
       "133904",
       "093903",
       "243903",
       "208903",
       "186903",
       "018906",
       "118902",
       "057912",
       "070907",
       "109907",
       "119902",
       "037904",
       "246907",
       "121904",
       "132902",
       "155901",
       "124901",
       "221911",
       "210902",
       "016901",
       "050909",
       "126905",
       "007902",
       "015916",
       "134901",
       "102901",
       "128901",
       "101914",
       "129903",
       "126906",
       "220907",
       "242905",
       "129904",
       "131001",
       "128902",
       "113906",
       "220914",
       "175907",
       "248901",
       "133903",
       "092902",
       "014906",
       "137901",
       "121905",
       "101915",
       "058905",
       "232901",
       "138902",
       "018907",
       "100903",
       "219905",
       "061905",
       "031905",
       "125906",
       "075902",
       "108912",
       "101916",
       "254902",
       "161906",
       "247903",
       "108914",
       "107910",
       "227912",
       "061912",
       "227913",
       "220910",
       "079901",
       "058906",
       "141901",
       "057913",
       "201903",
       "240901",
       "245901",
       "113905",
       "185904",
       "193902",
       "246913",
       "019914",
       "090902",
       "187906",
       "145911",
       "074909",
       "110902",
       "201904",
       "061902",
       "144902",
       "246908",
       "146906",
       "019908",
       "212903",
       "034905",
       "049907",
       "072909",
       "111902",
       "181908",
       "061914",
       "140904",
       "187907",
       "150901",
       "028902",
       "077902",
       "160905",
       "141902",
       "178906",
       "116906",
       "092903",
       "083902",
       "168902",
       "161907",
       "054902",
       "031906",
       "241906",
       "043919",
       "113903",
       "152901",
       "152906",
       "127905",
       "003903",
       "028903",
       "100907",
       "245902",
       "007904",
       "129905",
       "154901",
       "170906",
       "107906",
       "109908",
       "019910",
       "227907",
       "220908",
       "022902",
       "027904",
       "189901",
       "094904",
       "073903",
       "102902",
       "161908",
       "234905",
       "174909",
       "157901",
       "158904",
       "205904",
       "019903",
       "025905",
       "070915",
       "108906",
       "231901",
       "011905",
       "161909",
       "043907",
       "090903",
       "034906",
       "162904",
       "223902",
       "010901",
       "163908",
       "043908",
       "096904",
       "164901",
       "108907",
       "018902",
       "221904",
       "057914",
       "147903",
       "062906",
       "197902",
       "165901",
       "070908",
       "039905",
       "161903",
       "166903",
       "175910",
       "200902",
       "070909",
       "112907",
       "184904",
       "250903",
       "182903",
       "108908",
       "238902",
       "169908",
       "108915",
       "170903",
       "161910",
       "209902",
       "018903",
       "072910",
       "040901",
       "173901",
       "143902",
       "109910",
       "201907",
       "225902",
       "080901",
       "049902",
       "009901",
       "167902",
       "198906",
       "138903",
       "107908",
       "174904",
       "163903",
       "094903",
       "093904",
       "035903",
       "001906",
       "123905",
       "079906",
       "019905",
       "046901",
       "170908",
       "152902",
       "230906",
       "153905",
       "037908",
       "236901",
       "252902",
       "176902",
       "089903",
       "169902",
       "062902",
       "145906",
       "015910",
       "112906",
       "139911",
       "154903",
       "015915",
       "244905",
       "061911",
       "069902",
       "235904",
       "153903",
       "145907",
       "205905",
       "050904",
       "200906",
       "252903",
       "140905",
       "187910",
       "125903",
       "181905",
       "230903",
       "201908",
       "051901",
       "104907",
       "048903",
       "158905",
       "001907",
       "070910",
       "182906",
       "090904",
       "033902",
       "042905",
       "249906",
       "139909",
       "101917",
       "063906",
       "013902",
       "020908",
       "082903",
       "184908",
       "195901",
       "109914",
       "119903",
       "179901",
       "095904",
       "039903",
       "013903",
       "172905",
       "227904",
       "108909",
       "061903",
       "092904",
       "032902",
       "251902",
       "095905",
       "043910",
       "019912",
       "007905",
       "117904",
       "031909",
       "061906",
       "184901",
       "178908",
       "123907",
       "123908",
       "085902",
       "007906",
       "247904",
       "091913",
       "028906",
       "169909",
       "139912",
       "125905",
       "189902",
       "167904",
       "043911",
       "098903",
       "108910",
       "043912",
       "099903",
       "034907",
       "116908",
       "250904",
       "190903",
       "054903",
       "066005",
       "067907",
       "231902",
       "245903",
       "192901",
       "019911",
       "070911",
       "019906",
       "196903",
       "137902",
       "045903",
       "175911",
       "093905",
       "057916",
       "206902",
       "161912",
       "214901",
       "031911",
       "126907",
       "067908",
       "188902",
       "194903",
       "137903",
       "041902",
       "161922",
       "178909",
       "076903",
       "160904",
       "166904",
       "069901",
       "199901",
       "014907",
       "214903",
       "152908",
       "110905",
       "177901",
       "073905",
       "076904",
       "246909",
       "075908",
       "237905",
       "199902",
       "104903",
       "128903",
       "037907",
       "091914",
       "232902",
       "092906",
       "123913",
       "169911",
       "014908",
       "112909",
       "074917",
       "226903",
       "015907",
       "203901",
       "031912",
       "066902",
       "071904",
       "233901",
       "214902",
       "105902",
       "245904",
       "206901",
       "022903",
       "058909",
       "117903",
       "061908",
       "042903",
       "084909",
       "137904",
       "031913",
       "031914",
       "182904",
       "074911",
       "094902",
       "207901",
       "075903",
       "129910",
       "083901",
       "008902",
       "094901",
       "083903",
       "012901",
       "152909",
       "242902",
       "108911",
       "210903",
       "101924",
       "204904",
       "091906",
       "143903",
       "047905",
       "115902",
       "100904",
       "023902",
       "019909",
       "205906",
       "049909",
       "013905",
       "152903",
       "249908",
       "001909",
       "011904",
       "110906",
       "026903",
       "208902",
       "071909",
       "015909",
       "026902",
       "218901",
       "015908",
       "085903",
       "015917",
       "015912",
       "098904",
       "170907",
       "101920",
       "117907",
       "092907",
       "101919",
       "140907",
       "184902",
       "063903",
       "229905",
       "079910",
       "127906",
       "156902",
       "072903",
       "216901",
       "247906",
       "211902",
       "182905",
       "140908",
       "112910",
       "112901",
       "110907",
       "057919",
       "171902",
       "020906",
       "143905",
       "177902",
       "205907",
       "153904",
       "146907",
       "201910",
       "246911",
       "081904",
       "014909",
       "210904",
       "022004",
       "222901",
       "129906",
       "019907",
       "084906",
       "211901",
       "056902",
       "166905",
       "246912",
       "149902",
       "072901",
       "224901",
       "158902",
       "210905",
       "091907",
       "111903",
       "091918",
       "101921",
       "071908",
       "221905",
       "074912",
       "107907",
       "228903",
       "212904",
       "014910",
       "219903",
       "178912",
       "096905",
       "212905",
       "230908",
       "230904",
       "240903",
       "232904",
       "232903",
       "122902",
       "018904",
       "049903",
       "108916",
       "091908",
       "234906",
       "158906",
       "180902",
       "126908",
       "226908",
       "244903",
       "235902",
       "181907",
       "143904",
       "161914",
       "089905",
       "059902",
       "226906",
       "237904",
       "049908",
       "018905",
       "229904",
       "102903",
       "226905",
       "070912",
       "184903",
       "240904",
       "045905",
       "044902",
       "223904",
       "037909",
       "108913",
       "100908",
       "161916",
       "181906",
       "178915",
       "201914",
       "202905",
       "168903",
       "062905",
       "073904",
       "001908",
       "241904",
       "242903",
       "033904",
       "092908",
       "220920",
       "040902",
       "212906",
       "091909",
       "091910",
       "110908",
       "109911",
       "243905",
       "180904",
       "170904",
       "234907",
       "153907",
       "105905",
       "005904",
       "248902",
       "250907",
       "212910",
       "200904",
       "174906",
       "116909",
       "196902",
       "224902",
       "229903",
       "081905",
       "043914",
       "221912",
       "250905",
       "062903",
       "062904",
       "071905",
       "253901",
       "003906",
       "025906"
  )


#create list of URLs to "crawl"
url_list<-paste0(base_url,cdns)


#loop through URLS and pull each district's data into a separate data frame
dfList <- lapply(url_list, function(i) {
  tryCatch({
    webpage <- read_html(i)
    draft_table <- html_nodes(webpage, 'table')
    draft <- html_table(draft_table)[[2]]
    return(draft)
  }, error = function(e) {
    # Log the error message
    message(sprintf("Error processing %s: %s", i, e$message))
    # Return NULL to indicate an error occurred
    return(NULL)
  })
})


#add district id to each table
dfList <- Map(function(x, y) {
  x$district_id <- y
  x
},

dfList,
c(cdns))

#bind all the individual district tables together
finaldf <- do.call(rbind, dfList)


# Set the working directory
wd <- setwd(paste0(user_name, save_location))

# Write the first table to an Excel file
write.csv(finaldf, paste0(user_name, save_location, "\\19_20_act_fin_SGS.csv"), row.names = FALSE)

